-- ๐ง ููู ุฅุตูุงุญ ุงูุญุณุงุจุงุช ุงูููููุฏุฉ (Fix Missing Accounts)
-- ูููู ูุฐุง ุงูููู ุจูุญุต ุงูุญุณุงุจุงุช ุงูุฃุณุงุณูุฉ ูู ุงููุธุงู ูุฅูุดุงุฆูุง ุฅุฐุง ูุงูุช ููููุฏุฉ.
-- ูุนุชูุฏ ุนูู ุฏููู ุงูุญุณุงุจุงุช ุงููุตุฑู ุงูููุงุณู ุงููุณุชุฎุฏู ูู ุงููุธุงู.

DO $$
DECLARE
    v_org_id uuid;
    v_parent_id uuid;
    v_count integer := 0;
    v_created integer := 0;
    
    -- ููุน ูุคูุช ูุชุฎุฒูู ุจูุงูุงุช ุงูุญุณุงุจ
    TYPE AccountRecord IS RECORD (
        code text,
        name text,
        type text,
        is_group boolean,
        parent_code text
    );
    
    v_acc AccountRecord;
    v_accounts AccountRecord[];
BEGIN
    RAISE NOTICE '๐ ุจุฏุก ูุญุต ูุฅุตูุงุญ ุงูุญุณุงุจุงุช ุงูููููุฏุฉ...';

    -- ุงูุญุตูู ุนูู ูุนุฑู ุงูููุธูุฉ (ุฃูู ููุธูุฉ)
    SELECT id INTO v_org_id FROM public.organizations LIMIT 1;
    
    IF v_org_id IS NULL THEN
        -- ุฅูุดุงุก ููุธูุฉ ุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ุชูุฌุฏ
        INSERT INTO public.organizations (name) VALUES ('ุงูุดุฑูุฉ ุงูุงูุชุฑุงุถูุฉ') RETURNING id INTO v_org_id;
        RAISE NOTICE 'โ ุชู ุฅูุดุงุก ููุธูุฉ ุงูุชุฑุงุถูุฉ.';
    END IF;

    -- ุชุนุฑูู ูุงุฆูุฉ ุงูุญุณุงุจุงุช ุงูุฃุณุงุณูุฉ (ูุฑุชุจุฉ ุญุณุจ ุงููุณุชูู ูุถูุงู ูุฌูุฏ ุงูุฃุจ)
    v_accounts := ARRAY[
        -- ุงููุณุชูู ุงูุฃูู (ุงูุฌุฐูุฑ)
        ('1', 'ุงูุฃุตูู', 'ASSET', true, NULL),
        ('2', 'ุงูุฎุตูู (ุงูุฅูุชุฒุงูุงุช)', 'LIABILITY', true, NULL),
        ('3', 'ุญููู ุงูููููุฉ', 'EQUITY', true, NULL),
        ('4', 'ุงูุฅูุฑุงุฏุงุช', 'REVENUE', true, NULL),
        ('5', 'ุงููุตุฑููุงุช', 'EXPENSE', true, NULL),

        -- ุงููุณุชูู ุงูุซุงูู (ูุฌููุนุงุช ุฑุฆูุณูุฉ)
        ('11', 'ุงูุฃุตูู ุบูุฑ ุงููุชุฏุงููุฉ', 'ASSET', true, '1'),
        ('12', 'ุงูุฃุตูู ุงููุชุฏุงููุฉ', 'ASSET', true, '1'),
        ('21', 'ุงูุฎุตูู ุบูุฑ ุงููุชุฏุงููุฉ', 'LIABILITY', true, '2'),
        ('22', 'ุงูุฎุตูู ุงููุชุฏุงููุฉ', 'LIABILITY', true, '2'),
        ('31', 'ุฑุฃุณ ุงููุงู', 'EQUITY', false, '3'),
        ('32', 'ุงูุฃุฑุจุงุญ ุงููุจูุงุฉ / ุงููุฑุญูุฉ', 'EQUITY', false, '3'),
        ('41', 'ุฅูุฑุงุฏุงุช ุงููุดุงุท (ุงููุจูุนุงุช)', 'REVENUE', true, '4'),
        ('42', 'ุฅูุฑุงุฏุงุช ุฃุฎุฑู', 'REVENUE', true, '4'),
        ('51', 'ุชูููุฉ ุงููุจูุนุงุช (COGS)', 'EXPENSE', true, '5'),
        ('52', 'ูุตุฑููุงุช ุงูุจูุน ูุงูุชุณููู', 'EXPENSE', true, '5'),
        ('53', 'ุงููุตุฑููุงุช ุงูุฅุฏุงุฑูุฉ ูุงูุนููููุฉ', 'EXPENSE', true, '5'),

        -- ุงููุณุชูู ุงูุซุงูุซ ูุงูุฑุงุจุน (ุญุณุงุจุงุช ุงููุธุงู SYSTEM_ACCOUNTS)
        -- ุงูุฃุตูู
        ('111', 'ุงูุฃุตูู ุงูุซุงุจุชุฉ (ุจุงูุตุงูู)', 'ASSET', true, '11'),
        ('1119', 'ูุฌูุน ุฅููุงู ุงูุฃุตูู ุงูุซุงุจุชุฉ', 'ASSET', false, '111'),
        ('121', 'ุงููุฎุฒูู', 'ASSET', true, '12'),
        ('1211', 'ูุฎุฒูู ุงูุฎุงูุงุช ูุงูููุงุฏ ุงูุฃูููุฉ', 'ASSET', false, '121'),
        ('1213', 'ูุฎุฒูู ุงูููุชุฌ ุงูุชุงู (ุจุถุงุนุฉ ููุจูุน)', 'ASSET', false, '121'),
        ('122', 'ุงูุนููุงุก ูุงููุฏูููู', 'ASSET', true, '12'),
        ('1221', 'ุงูุนููุงุก', 'ASSET', false, '122'),
        ('1222', 'ุฃูุฑุงู ุงููุจุถ (ุดููุงุช ุชุญุช ุงูุชุญุตูู)', 'ASSET', false, '122'),
        ('1223', 'ุณูู ุงูููุธููู', 'ASSET', false, '122'),
        ('123', 'ุงูููุฏูุฉ ููุง ูู ุญูููุง', 'ASSET', true, '12'),
        ('1231', 'ุงูููุฏูุฉ ุจุงูุตูุฏูู (ุงูุฎุฒููุฉ ุงูุฑุฆูุณูุฉ)', 'ASSET', false, '123'),
        ('1232', 'ุงูุจููู (ุญุณุงุจุงุช ุฌุงุฑูุฉ)', 'ASSET', true, '123'),
        ('124', 'ุฃุฑุตุฏุฉ ูุฏููุฉ ุฃุฎุฑู', 'ASSET', true, '12'),
        ('1241', 'ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (ูุฏุฎูุงุช)', 'ASSET', false, '124'),

        -- ุงูุฎุตูู
        ('221', 'ุงูููุฑุฏูู', 'LIABILITY', false, '22'),
        ('222', 'ุฃูุฑุงู ุงูุฏูุน (ุดููุงุช ุตุงุฏุฑุฉ)', 'LIABILITY', false, '22'),
        ('223', 'ูุตูุญุฉ ุงูุถุฑุงุฆุจ (ุงูุชุฒุงูุงุช)', 'LIABILITY', true, '22'),
        ('2231', 'ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (ูุฎุฑุฌุงุช)', 'LIABILITY', false, '223'),
        ('2232', 'ุถุฑูุจุฉ ุงูุฎุตู ูุงูุชุญุตูู (ุนูููุง)', 'LIABILITY', false, '223'),
        ('224', 'ููุฆุฉ ุงูุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ', 'LIABILITY', false, '22'),
        ('226', 'ุชุฃูููุงุช ูุฏูุนุงุช ููุฏูุฉ ูู ุงูุนููุงุก', 'LIABILITY', false, '22'),

        -- ุญููู ุงูููููุฉ
        ('3999', 'ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ (ุญุณุงุจ ูุณูุท)', 'EQUITY', false, '3'),

        -- ุงูุฅูุฑุงุฏุงุช
        ('411', 'ุฅูุฑุงุฏ ุงููุจูุนุงุช', 'REVENUE', false, '41'),
        ('412', 'ูุฑุฏูุฏุงุช ุงููุจูุนุงุช', 'REVENUE', false, '41'),
        ('413', 'ุฎุตู ูุณููุญ ุจู', 'REVENUE', false, '41'),
        ('421', 'ุฅูุฑุงุฏุงุช ูุชููุนุฉ', 'REVENUE', false, '42'),
        ('422', 'ุฅูุฑุงุฏ ุฎุตููุงุช ูุฌุฒุงุกุงุช ุงูููุธููู', 'REVENUE', false, '42'),
        ('423', 'ููุงุฆุฏ ุจูููุฉ ุฏุงุฆูุฉ', 'REVENUE', false, '42'),

        -- ุงููุตุฑููุงุช
        ('511', 'ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ', 'EXPENSE', false, '51'),
        ('512', 'ุชุณููุงุช ุงูุฌุฑุฏ (ุนุฌุฒ ุงููุฎุฒูู)', 'EXPENSE', false, '51'),
        ('531', 'ุงูุฑูุงุชุจ ูุงูุฃุฌูุฑ', 'EXPENSE', false, '53'),
        ('5312', 'ููุงูุขุช ูุญูุงูุฒ', 'EXPENSE', false, '53'),
        ('533', 'ุฅููุงู ุงูุฃุตูู ุงูุซุงุจุชุฉ', 'EXPENSE', false, '53'),
        ('534', 'ูุตุฑููุงุช ุจูููุฉ', 'EXPENSE', false, '53')
    ]::AccountRecord[];

    -- ุงูุชูุฑุงุฑ ุนูู ุงููุงุฆูุฉ
    FOREACH v_acc IN ARRAY v_accounts
    LOOP
        -- ุงูุชุญูู ูู ูุฌูุฏ ุงูุญุณุงุจ
        IF NOT EXISTS (SELECT 1 FROM public.accounts WHERE code = v_acc.code) THEN
            -- ุงูุจุญุซ ุนู ูุนุฑู ุงูุฃุจ
            v_parent_id := NULL;
            IF v_acc.parent_code IS NOT NULL THEN
                SELECT id INTO v_parent_id FROM public.accounts WHERE code = v_acc.parent_code;
                
                -- ุฅุฐุง ูู ููุฌุฏ ุงูุฃุจุ ูุง ูููู ุฅูุดุงุก ุงูุงุจู (ูุฌุจ ุฃู ูููู ุงูุฃุจ ูุฏ ุชู ุฅูุดุงุคู ูู ุฏูุฑุฉ ุณุงุจูุฉ ูุฃู ุงููุงุฆูุฉ ูุฑุชุจุฉ)
                IF v_parent_id IS NULL THEN
                    RAISE NOTICE 'โ๏ธ ุชุฎุทู ุงูุญุณุงุจ % (%) ูุนุฏู ูุฌูุฏ ุงูุญุณุงุจ ุงูุฑุฆูุณู %', v_acc.name, v_acc.code, v_acc.parent_code;
                    CONTINUE;
                END IF;
            END IF;

            -- ุฅูุดุงุก ุงูุญุณุงุจ
            INSERT INTO public.accounts (code, name, type, is_group, parent_id, organization_id, is_active) 
            VALUES (v_acc.code, v_acc.name, v_acc.type, v_acc.is_group, v_parent_id, v_org_id, true);
            
            v_created := v_created + 1;
            RAISE NOTICE 'โ ุชู ุฅูุดุงุก ุงูุญุณุงุจ: % - %', v_acc.code, v_acc.name;
        END IF;
    END LOOP;

    RAISE NOTICE '--------------------------------------------------';
    IF v_created > 0 THEN
        RAISE NOTICE '๐ ุชู ุฅุตูุงุญ ูุฅูุดุงุก % ุญุณุงุจ ููููุฏ ุจูุฌุงุญ.', v_created;
    ELSE
        RAISE NOTICE 'โจ ุงููุธุงู ุณููู! ุฌููุน ุงูุญุณุงุจุงุช ุงูุฃุณุงุณูุฉ ููุฌูุฏุฉ.';
    END IF;
END $$;