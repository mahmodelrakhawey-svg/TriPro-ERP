----- /dev/null
----@@ -0,0 +1,126 @@
----### 2. ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„ `services/setup_complete_demo.sql`
----- c:\Users\pc\Desktop\TriPro-ERP\services\setup_complete_demo.sql
----@@ -148,6 +148,7 @@
----@@ -162,6 +163,7 @@
----@@ -603,6 +605,82 @@
-- ğŸ› ï¸ Ø³ÙƒØ±Ø¨Øª Ø¥ØµÙ„Ø§Ø­ ÙˆØªÙˆØ­ÙŠØ¯ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ù†Ø³Ø®Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨)
-- ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ù„Ù„Ø±ØµÙŠØ¯ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨

BEGIN;

-- 0. ØªØ­Ø³ÙŠÙ†Ø§Øª ÙˆÙ‚Ø§Ø¦ÙŠØ©: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù‚Ø¯Ù…Ø§Ù‹ Ù„ÙŠØ³ NULL
UPDATE public.invoices SET paid_amount = 0 WHERE paid_amount IS NULL;
ALTER TABLE public.invoices ALTER COLUMN paid_amount SET DEFAULT 0;

-- 1. Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±ØµÙŠØ¯ (Balance) Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
ALTER TABLE public.customers ADD COLUMN IF NOT EXISTS balance numeric DEFAULT 0;
ALTER TABLE public.suppliers ADD COLUMN IF NOT EXISTS balance numeric DEFAULT 0;

-- 1.5 Ø¥ØµÙ„Ø§Ø­ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙÙ‚ÙˆØ¯Ø§Ù‹)
DO $$
BEGIN
    -- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù†Ø©
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'credit_notes') THEN
        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'credit_notes' AND column_name = 'status') THEN
            ALTER TABLE public.credit_notes ADD COLUMN status text DEFAULT 'posted';
        END IF;
    END IF;

    -- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'debit_notes') THEN
        IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'debit_notes' AND column_name = 'status') THEN
            ALTER TABLE public.debit_notes ADD COLUMN status text DEFAULT 'posted';
        END IF;
    END IF;
END $$;

-- 2. Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ·Ø§Ø¨Ù‚ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ…Ø§Ù…Ø§Ù‹)
CREATE OR REPLACE FUNCTION public.recalculate_partner_balances()
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    partner RECORD;
    v_balance numeric;
BEGIN
    -- Ø£) Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    FOR partner IN SELECT id FROM public.customers LOOP
        v_balance := 0;
        
        -- 1. Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ù…Ø¯ÙŠÙ† +) - (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù‚Ø¯Ù…Ø§Ù‹ ÙÙŠÙ‡Ø§)
        -- Ø§Ù„Ù…Ù†Ø·Ù‚: Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ø§Ù„Ù…Ø³ÙˆØ¯Ø© ØªØ­Ø³Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ ÙˆÙŠØ®ØµÙ… Ù…Ù†Ù‡Ø§ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù‚Ø¯Ù…Ø§Ù‹
        SELECT v_balance + COALESCE(SUM(total_amount - COALESCE(paid_amount, 0)), 0) INTO v_balance
        FROM public.invoices 
        WHERE customer_id = partner.id AND status != 'draft';

        -- 2. Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ (Ø¯Ø§Ø¦Ù† -)
        -- ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ† (DEP) Ù„ØªØ·Ø§Ø¨Ù‚ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.receipt_vouchers 
        WHERE customer_id = partner.id
        AND (voucher_number NOT LIKE 'DEP-%' OR voucher_number IS NULL);

        -- 3. Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¯Ø§Ø¦Ù† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.sales_returns 
        WHERE customer_id = partner.id AND status = 'posted';

        -- 4. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù†Ø© (Ø¯Ø§Ø¦Ù† -)
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'credit_notes') THEN
            SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
            FROM public.credit_notes 
            WHERE customer_id = partner.id AND status = 'posted';
        END IF;

        -- 5. Ø§Ù„Ø´ÙŠÙƒØ§Øª (Ø¯Ø§Ø¦Ù† -)
        -- ØªØ¹Ø¯ÙŠÙ„: ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ®ØµÙ… Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ø§ Ø¯Ø§Ù…Øª ØºÙŠØ± Ù…Ø±ÙÙˆØ¶Ø© (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„)
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.cheques 
        WHERE party_id = partner.id AND type = 'incoming' AND status != 'rejected';

        -- ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
        UPDATE public.customers SET balance = v_balance WHERE id = partner.id;
    END LOOP;

    -- Ø¨) Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    FOR partner IN SELECT id FROM public.suppliers LOOP
        v_balance := 0;

        -- 1. ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¯Ø§Ø¦Ù† +)
        SELECT v_balance + COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.purchase_invoices 
        WHERE supplier_id = partner.id AND status != 'draft';

        -- 2. Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù (Ù…Ø¯ÙŠÙ† -)
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.payment_vouchers 
        WHERE supplier_id = partner.id;

        -- 3. Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ù…Ø¯ÙŠÙ† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.purchase_returns 
        WHERE supplier_id = partner.id AND status = 'posted';

        -- 4. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø¯ÙŠÙ† -)
        IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'debit_notes') THEN
            SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
            FROM public.debit_notes 
            WHERE supplier_id = partner.id AND status = 'posted';
        END IF;

        -- ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯
        UPDATE public.suppliers SET balance = v_balance WHERE id = partner.id;
    END LOOP;
END;
$$;

-- 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
SELECT public.recalculate_partner_balances();

-- 4. ÙØ­Øµ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙŠ Ù„ÙŠØ³ Ù„Ù‡Ø§ Ù‚ÙŠÙˆØ¯ (Orphaned Documents)
DO $$
DECLARE
    r RECORD;
    v_journal_id uuid;
BEGIN
    -- ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯
    FOR r IN SELECT id, invoice_number FROM public.invoices WHERE status = 'posted' AND related_journal_entry_id IS NULL LOOP
        -- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‚ÙŠØ¯ Ø³Ø§Ø¨Ù‚ Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø§Ù„ØªÙƒØ±Ø§Ø±
        SELECT id INTO v_journal_id FROM public.journal_entries WHERE reference = r.invoice_number LIMIT 1;
        
        IF v_journal_id IS NOT NULL THEN
            -- Ø±Ø¨Ø· Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            UPDATE public.invoices SET related_journal_entry_id = v_journal_id WHERE id = r.id;
        ELSE
            -- Ù†ØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¥Ù„Ù‰ Ù…Ø³ÙˆØ¯Ø© Ù„ØªØ¬Ø§ÙˆØ² ÙØ­Øµ "Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø±Ø­Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„" Ø«Ù… Ù†Ù†Ø´Ø¦ Ø§Ù„Ù‚ÙŠØ¯
            UPDATE public.invoices SET status = 'draft' WHERE id = r.id;
            PERFORM public.approve_invoice(r.id);
        END IF;
    END LOOP;

    -- Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶
    FOR r IN SELECT id, voucher_number, treasury_account_id FROM public.receipt_vouchers WHERE related_journal_entry_id IS NULL LOOP
        SELECT id INTO v_journal_id FROM public.journal_entries WHERE reference = r.voucher_number LIMIT 1;
        
        IF v_journal_id IS NOT NULL THEN
            UPDATE public.receipt_vouchers SET related_journal_entry_id = v_journal_id WHERE id = r.id;
        ELSE
            PERFORM public.approve_receipt_voucher(r.id, (SELECT id FROM public.accounts WHERE code = '1102' LIMIT 1));
        END IF;
    END LOOP;

    -- ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯
    FOR r IN SELECT id, invoice_number FROM public.purchase_invoices WHERE status = 'posted' AND related_journal_entry_id IS NULL LOOP
        SELECT id INTO v_journal_id FROM public.journal_entries WHERE reference = r.invoice_number LIMIT 1;
        
        IF v_journal_id IS NOT NULL THEN
            UPDATE public.purchase_invoices SET related_journal_entry_id = v_journal_id WHERE id = r.id;
        ELSE
            UPDATE public.purchase_invoices SET status = 'draft' WHERE id = r.id;
            PERFORM public.approve_purchase_invoice(r.id);
        END IF;
    END LOOP;

    -- Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù
    FOR r IN SELECT id, voucher_number, treasury_account_id FROM public.payment_vouchers WHERE related_journal_entry_id IS NULL LOOP
        SELECT id INTO v_journal_id FROM public.journal_entries WHERE reference = r.voucher_number LIMIT 1;
        
        IF v_journal_id IS NOT NULL THEN
            UPDATE public.payment_vouchers SET related_journal_entry_id = v_journal_id WHERE id = r.id;
        ELSE
            PERFORM public.approve_payment_voucher(r.id, (SELECT id FROM public.accounts WHERE code = '2201' LIMIT 1));
        END IF;
    END LOOP;
END $$;

COMMIT;

SELECT 'âœ… ØªÙ… ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ø±ØµØ¯Ø© (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨) ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù‚ÙŠÙˆØ¯.' as result;
