--- /dev/null
-- c:\Users\pc\Desktop\TriPro-ERP\services\fix_customer_balance_mismatch.sql
--@@ -0,0 +1,126 @@
-- ğŸ› ï¸ Ø³ÙƒØ±Ø¨Øª Ø¥ØµÙ„Ø§Ø­ ÙˆØªÙˆØ­ÙŠØ¯ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
-- ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ù„Ù„Ø±ØµÙŠØ¯ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ«Ù‚Ø©
BEGIN;
-- 1. Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±ØµÙŠØ¯ (Balance) Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
ALTER TABLE public.customers ADD COLUMN IF NOT EXISTS balance numeric DEFAULT 0;
ALTER TABLE public.suppliers ADD COLUMN IF NOT EXISTS balance numeric DEFAULT 0;

-- 2. Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ (Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙ…ÙˆØ±Ø¯ÙŠÙ†)
CREATE OR REPLACE FUNCTION public.recalculate_partner_balances()
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    partner RECORD;
    v_balance numeric;
BEGIN
    -- Ø£) Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    FOR partner IN SELECT id FROM public.customers LOOP
        v_balance := 0;
        
        -- 1. Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ù…Ø¯ÙŠÙ† +) - (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù‚Ø¯Ù…Ø§Ù‹ ÙÙŠÙ‡Ø§)
        -- Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø®ØµÙ… Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù‚Ø¯Ù…Ø§Ù‹ Ù„Ø£Ù† Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ ÙŠØ³Ø¬Ù„ Ø§Ù„ØµØ§ÙÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
        SELECT v_balance + COALESCE(SUM(total_amount - COALESCE(paid_amount, 0)), 0) INTO v_balance
        FROM public.invoices 
        WHERE customer_id = partner.id AND status NOT IN ('draft', 'cancelled');

        -- 2. Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ (Ø¯Ø§Ø¦Ù† -)
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.receipt_vouchers 
        WHERE customer_id = partner.id;
 
        -- 3. Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¯Ø§Ø¦Ù† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.sales_returns 
        WHERE customer_id = partner.id AND status = 'posted';

        -- 4. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù†Ø© (Ø¯Ø§Ø¦Ù† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.credit_notes 
        WHERE customer_id = partner.id AND status = 'posted';

        -- 5. Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯Ø§Ø¦Ù† -)
        -- Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„ØªÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ 'collected' ØªØ¹ØªØ¨Ø± Ø³Ø¯Ø§Ø¯Ø§Ù‹
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.cheques 
        WHERE party_id = partner.id AND type = 'incoming' AND status = 'collected';

        -- ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
        UPDATE public.customers SET balance = v_balance WHERE id = partner.id;
    END LOOP;

    -- Ø¨) Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    FOR partner IN SELECT id FROM public.suppliers LOOP
        v_balance := 0;

        -- 1. ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¯Ø§Ø¦Ù† +)
        SELECT v_balance + COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.purchase_invoices 
        WHERE supplier_id = partner.id AND status NOT IN ('draft', 'cancelled');

        -- 2. Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù (Ù…Ø¯ÙŠÙ† -)
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.payment_vouchers 
        WHERE supplier_id = partner.id;

        -- 3. Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ù…Ø¯ÙŠÙ† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.purchase_returns 
        WHERE supplier_id = partner.id AND status = 'posted';

        -- 4. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø¯ÙŠÙ† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.debit_notes 
        WHERE supplier_id = partner.id AND status = 'posted';

        -- ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯
        UPDATE public.suppliers SET balance = v_balance WHERE id = partner.id;
    END LOOP;

    RAISE NOTICE 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­.';
END;
$$;

-- 3. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
SELECT public.recalculate_partner_balances();

-- 4. ÙØ­Øµ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙŠ Ù„ÙŠØ³ Ù„Ù‡Ø§ Ù‚ÙŠÙˆØ¯ (Orphaned Documents)
-- Ù‡Ø°Ø§ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø§Ø®ØªÙ„Ø§Ù Ø¨ÙŠÙ† ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¯ÙØªØ± Ø§Ù„Ø£Ø³ØªØ§Ø° Ø§Ù„Ø¹Ø§Ù…
DO $$
DECLARE
    r RECORD;
BEGIN
    -- ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯
    FOR r IN SELECT id FROM public.invoices WHERE status = 'posted' AND related_journal_entry_id IS NULL LOOP
        PERFORM public.approve_invoice(r.id);
    END LOOP;

    -- Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶
    FOR r IN SELECT id, treasury_account_id FROM public.receipt_vouchers WHERE related_journal_entry_id IS NULL LOOP
        -- Ù†Ø­ØªØ§Ø¬ Ù„Ø­Ø³Ø§Ø¨ Ø¯Ø§Ø¦Ù† (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡) Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ØŒ Ø³Ù†ÙØªØ±Ø¶Ù‡ 1102
        PERFORM public.approve_receipt_voucher(r.id, (SELECT id FROM public.accounts WHERE code = '1102' LIMIT 1));
    END LOOP;

    -- ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù‚ÙŠØ¯
    FOR r IN SELECT id FROM public.purchase_invoices WHERE status = 'posted' AND related_journal_entry_id IS NULL LOOP
        PERFORM public.approve_purchase_invoice(r.id);
    END LOOP;
    FOR r IN SELECT id, treasury_account_id FROM public.payment_vouchers WHERE related_journal_entry_id IS NULL LOOP
        -- Ù†Ø­ØªØ§Ø¬ Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¯ÙŠÙ† (Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†) Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ØŒ Ø³Ù†ÙØªØ±Ø¶Ù‡ 2201

    -- Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù

        PERFORM public.approve_payment_voucher(r.id, (SELECT id FROM public.accounts WHERE code = '2201' LIMIT 1));
    END LOOP;
END $$;

COMMIT;

SELECT 'âœ… ØªÙ… ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©.' as result;
```

### 2. ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„ `services/setup_complete_demo.sql`
Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø£ÙŠ ØªØ«Ø¨ÙŠØª Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†Ø¸Ø§Ù… ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„Ø¯ÙˆØ§Ù„.

```diff
--- c:\Users\pc\Desktop\TriPro-ERP\services\setup_complete_demo.sql
-- c:\Users\pc\Desktop\TriPro-ERP\services\setup_complete_demo.sql
--@@ -148,6 +148,7 @@
     tax_id text, -- alias for tax_number
     address text,
     credit_limit numeric DEFAULT 0,
     balance numeric DEFAULT 0,
     customer_type text DEFAULT 'individual',
     deleted_at timestamptz,
     deletion_reason text,
--@@ -162,6 +163,7 @@
     tax_id text, -- alias
     address text,
     contact_person text,
     balance numeric DEFAULT 0,
     deleted_at timestamptz,
     deletion_reason text,
     created_at timestamptz DEFAULT now() NOT NULL
--@@ -603,6 +605,82 @@
 END;
 $$
-- Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ (Ø¹Ù…Ù„Ø§Ø¡ ÙˆÙ…ÙˆØ±Ø¯ÙŠÙ†)
CREATE OR REPLACE FUNCTION public.recalculate_partner_balances()
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    partner RECORD;
    v_balance numeric;
BEGIN
    -- Ø£) Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    FOR partner IN SELECT id FROM public.customers LOOP
        v_balance := 0;
        
        -- 1. Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ù…Ø¯ÙŠÙ† +) - (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù‚Ø¯Ù…Ø§Ù‹ ÙÙŠÙ‡Ø§)
        SELECT v_balance + COALESCE(SUM(total_amount - COALESCE(paid_amount, 0)), 0) INTO v_balance
        FROM public.invoices 
        WHERE customer_id = partner.id AND status NOT IN ('draft', 'cancelled');

        -- 2. Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ (Ø¯Ø§Ø¦Ù† -)
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.receipt_vouchers 
        WHERE customer_id = partner.id;

        -- 3. Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¯Ø§Ø¦Ù† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.sales_returns 
        WHERE customer_id = partner.id AND status = 'posted';

        -- 4. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù†Ø© (Ø¯Ø§Ø¦Ù† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.credit_notes 
        WHERE customer_id = partner.id AND status = 'posted';

        -- 5. Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…Ø­ØµÙ„Ø© (Ø¯Ø§Ø¦Ù† -)
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.cheques 
        WHERE party_id = partner.id AND type = 'incoming' AND status = 'collected';

        -- ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
        UPDATE public.customers SET balance = v_balance WHERE id = partner.id;
    END LOOP;

    -- Ø¨) Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
    FOR partner IN SELECT id FROM public.suppliers LOOP
        v_balance := 0;

        -- 1. ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¯Ø§Ø¦Ù† +)
        SELECT v_balance + COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.purchase_invoices 
        WHERE supplier_id = partner.id AND status NOT IN ('draft', 'cancelled');

        -- 2. Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù (Ù…Ø¯ÙŠÙ† -)
        SELECT v_balance - COALESCE(SUM(amount), 0) INTO v_balance
        FROM public.payment_vouchers 
        WHERE supplier_id = partner.id;

        -- 3. Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ù…Ø¯ÙŠÙ† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.purchase_returns 
        WHERE supplier_id = partner.id AND status = 'posted';

        -- 4. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø¯ÙŠÙ† -)
        SELECT v_balance - COALESCE(SUM(total_amount), 0) INTO v_balance
        FROM public.debit_notes 
        WHERE supplier_id = partner.id AND status = 'posted';

        -- ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ±Ø¯
        UPDATE public.suppliers SET balance = v_balance WHERE id = partner.id;
    END LOOP;
END;
$$;

 -- ========= 3. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Seeding) =========
 
 DO $$
